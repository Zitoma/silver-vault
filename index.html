<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>Silver Vault</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0a0a0f;--card:#14141c;--card2:#1a1a24;--text:#f5f5f7;--muted:#71717a;--border:rgba(255,255,255,0.1);--accent:#c9a227;--accent2:#e8a849;--success:#22c55e;--danger:#ef4444;--silver:#a8a8a8}
body{font-family:-apple-system,BlinkMacSystemFont,Roboto,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;padding-bottom:20px}

/* LOCK SCREEN */
.lock-screen{position:fixed;inset:0;background:var(--bg);z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px}
.lock-screen.hidden{display:none}
.lock-icon{font-size:60px;margin-bottom:20px}
.lock-title{font-size:20px;margin-bottom:8px}
.lock-subtitle{font-size:14px;color:var(--muted);margin-bottom:30px}
.pin-dots{display:flex;gap:16px;margin-bottom:30px}
.pin-dot{width:16px;height:16px;border-radius:50%;border:2px solid var(--muted);transition:all 0.2s}
.pin-dot.filled{background:var(--accent);border-color:var(--accent)}
.pin-dot.error{border-color:var(--danger);background:var(--danger);animation:shake 0.3s}
@keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-8px)}75%{transform:translateX(8px)}}
.pin-pad{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;max-width:280px}
.pin-btn{width:70px;height:70px;border-radius:50%;border:1px solid var(--border);background:var(--card);color:var(--text);font-size:28px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.1s}
.pin-btn:active{background:var(--accent);color:var(--bg);transform:scale(0.95)}
.pin-btn.empty{visibility:hidden}
.pin-btn.del{font-size:20px}
.lock-error{color:var(--danger);font-size:13px;margin-top:16px;height:20px}

header{background:var(--card);padding:16px;border-bottom:1px solid var(--border);position:sticky;top:0;z-index:100}
.header-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.logo{display:flex;align-items:center;gap:10px}
.logo-icon{width:40px;height:40px;background:linear-gradient(135deg,#d4d4d8,#71717a);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px}
.logo h1{font-size:18px;background:linear-gradient(135deg,#d4d4d8,#71717a);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.header-actions{display:flex;gap:8px;align-items:center}
.btn-lock{background:none;border:none;font-size:20px;cursor:pointer;padding:8px}
.price-box{background:var(--card2);padding:10px 16px;border-radius:20px;font-size:14px;display:flex;align-items:center;gap:10px;cursor:pointer}
.price-box strong{color:var(--text);font-size:16px}
.price-box span{color:var(--muted);font-size:12px}
.btn-refresh{background:none;border:none;color:var(--muted);cursor:pointer;padding:4px;font-size:16px}
.btn-refresh.spin{animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.stats-bar{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-bottom:8px}
.stats-bar-2{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
.stat-mini{background:var(--card2);padding:10px;border-radius:10px;text-align:center}
.stat-mini .value{font-size:15px;font-weight:700}
.stat-mini .value.silver{color:var(--silver)}
.stat-mini .value.gold{color:var(--accent2)}
.stat-mini .label{font-size:9px;color:var(--muted);text-transform:uppercase}
.price-info{text-align:center;font-size:11px;color:var(--muted);margin-top:10px;padding:10px;background:var(--card2);border-radius:10px}
.price-edit{background:var(--card2);padding:16px;border-radius:12px;margin-top:12px;display:none}
.price-edit.show{display:block}
.price-edit label{display:block;font-size:13px;color:var(--text);margin-bottom:10px}
.price-edit-row{display:flex;gap:10px;margin-bottom:12px}
.price-edit-row input{flex:1;padding:14px;background:var(--card);border:1px solid var(--border);border-radius:10px;color:var(--text);font-size:18px;font-weight:600}
.price-edit-row button{padding:14px 24px;background:var(--accent);border:none;border-radius:10px;color:var(--bg);font-weight:700;cursor:pointer;font-size:16px}
main{padding:16px}
.actions{display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap}
.search-box{flex:1;min-width:150px;position:relative}
.search-box input{width:100%;padding:12px 16px 12px 40px;background:var(--card);border:1px solid var(--border);border-radius:12px;color:var(--text);font-size:14px}
.search-box::before{content:"ğŸ”";position:absolute;left:14px;top:50%;transform:translateY(-50%)}
.btn-add{background:var(--accent);border:none;color:var(--bg);padding:12px 16px;border-radius:12px;font-weight:600;cursor:pointer;font-size:18px}
.btn-icon{background:var(--card2);border:1px solid var(--border);color:var(--text);padding:12px;border-radius:12px;cursor:pointer;font-size:16px}
.sort-row{display:flex;gap:8px;margin-bottom:16px;overflow-x:auto;padding-bottom:4px}
.sort-btn{background:var(--card);border:1px solid var(--border);color:var(--muted);padding:8px 12px;border-radius:20px;font-size:12px;cursor:pointer;white-space:nowrap}
.sort-btn.active{background:var(--accent);color:var(--bg);border-color:var(--accent)}
.coins-list{display:flex;flex-direction:column;gap:12px}
.coin-card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;cursor:pointer;transition:transform 0.1s}
.coin-card:active{transform:scale(0.98)}
.coin-header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
.coin-icon{width:50px;height:50px;background:var(--card2);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:24px;flex-shrink:0;overflow:hidden;position:relative}
.coin-icon img{width:100%;height:100%;object-fit:cover}
.coin-qty{position:absolute;top:-4px;right:-4px;background:var(--accent);color:var(--bg);font-size:10px;font-weight:700;padding:2px 6px;border-radius:10px}
.coin-info{flex:1;min-width:0}
.coin-info h3{font-size:15px;margin-bottom:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;display:flex;align-items:center;gap:6px}
.coin-info h3 .flag{font-size:14px}
.coin-meta{display:flex;align-items:center;gap:6px;font-size:12px;color:var(--muted);flex-wrap:wrap}
.purity-badge{background:#a8a8a8;color:#000;padding:2px 8px;border-radius:8px;font-weight:600;font-size:11px}
.coin-value{text-align:right;flex-shrink:0}
.coin-value .main{font-size:17px;font-weight:700}
.coin-value .metal{font-size:11px;color:var(--silver)}
.coin-value .premium{font-size:11px;color:var(--accent2)}
.coin-value .change{font-size:11px}
.coin-value .change.up{color:var(--success)}
.coin-value .change.down{color:var(--danger)}
.coin-details{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;padding-top:12px;border-top:1px solid var(--border);font-size:11px}
.coin-details span{color:var(--muted)}
.coin-details strong{color:var(--text)}
.empty-state{text-align:center;padding:60px 20px;color:var(--muted)}
.empty-state .icon{font-size:48px;margin-bottom:16px}
.empty-state h3{color:var(--text);margin-bottom:8px}
.chart-section{background:var(--card);border-radius:16px;padding:16px;margin-bottom:16px}
.chart-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.chart-header h3{font-size:14px;color:var(--muted)}
.chart-legend{display:flex;gap:12px;font-size:10px}
.chart-legend span{display:flex;align-items:center;gap:4px}
.chart-legend .dot{width:8px;height:8px;border-radius:50%}
.chart-legend .dot.metal{background:var(--silver)}
.chart-legend .dot.numis{background:var(--accent2)}
.chart-container{height:120px;display:flex;align-items:flex-end;gap:3px;padding-top:20px;position:relative}
.chart-bar-group{flex:1;display:flex;flex-direction:column;align-items:center;gap:1px}
.chart-bar{width:100%;border-radius:3px 3px 0 0;min-height:2px;transition:height 0.3s}
.chart-bar.metal{background:var(--silver)}
.chart-bar.numis{background:var(--accent2)}
.chart-labels{display:flex;justify-content:space-between;margin-top:8px;font-size:10px;color:var(--muted)}
.chart-empty{text-align:center;color:var(--muted);padding:30px;font-size:13px}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:1000;align-items:center;justify-content:center;padding:16px}
.modal.active{display:flex}
.modal-content{background:var(--card);border-radius:20px;width:100%;max-width:500px;max-height:90vh;overflow-y:auto}
.modal-header{display:flex;align-items:center;justify-content:space-between;padding:20px;border-bottom:1px solid var(--border);position:sticky;top:0;background:var(--card);z-index:10}
.modal-header h2{font-size:18px}
.btn-close{background:none;border:none;color:var(--muted);font-size:28px;cursor:pointer;padding:0 8px}
.modal-body{padding:20px}
.form-group{margin-bottom:16px}
.form-group label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
.form-group input,.form-group select,.form-group textarea{width:100%;padding:14px;background:var(--card2);border:1px solid var(--border);border-radius:10px;color:var(--text);font-size:16px}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.form-row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
.calc-preview{background:rgba(201,162,39,0.15);border:1px solid var(--accent);border-radius:12px;padding:16px;margin-bottom:16px}
.calc-preview-row{display:flex;justify-content:space-between;margin-bottom:8px}
.calc-preview-row:last-child{margin-bottom:0;padding-top:8px;border-top:1px solid var(--border)}
.calc-preview-row span{color:var(--muted);font-size:13px}
.calc-preview-row strong{color:var(--accent);font-size:15px}
.calc-preview-row strong.silver{color:var(--silver)}
.calc-preview-row strong.gold{color:var(--accent2)}
.calc-preview-row strong.total{font-size:18px}
.modal-footer{display:flex;gap:12px;padding:20px;border-top:1px solid var(--border)}
.btn-cancel{flex:1;padding:16px;background:var(--card2);border:1px solid var(--border);border-radius:12px;color:var(--text);cursor:pointer;font-size:16px}
.btn-save{flex:1;padding:16px;background:var(--accent);border:none;border-radius:12px;color:var(--bg);font-weight:700;cursor:pointer;font-size:16px}
.btn-danger{background:var(--danger)}
input:focus,select:focus,textarea:focus{outline:none;border-color:var(--accent)}
.photo-section{margin-bottom:16px}
.photo-preview{width:100%;height:100px;background:var(--card2);border:2px dashed var(--border);border-radius:12px;display:flex;align-items:center;justify-content:center;cursor:pointer;overflow:hidden}
.photo-preview img{width:100%;height:100%;object-fit:cover}
.photo-preview .placeholder{text-align:center;color:var(--muted)}
.photo-preview .placeholder span{font-size:28px;display:block}
#photoInput,#photoInput2{display:none}
.detail-view{display:none;position:fixed;inset:0;background:var(--bg);z-index:1001;overflow-y:auto}
.detail-view.active{display:block}
.detail-header{display:flex;align-items:center;justify-content:space-between;padding:16px;background:var(--card);position:sticky;top:0;z-index:10}
.detail-header h2{font-size:16px;flex:1;text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin:0 10px}
.btn-back,.btn-settings{width:44px;height:44px;border-radius:12px;border:none;display:flex;align-items:center;justify-content:center;font-size:20px;cursor:pointer}
.btn-back{background:var(--accent);color:var(--bg)}
.btn-settings{background:var(--accent);color:var(--bg)}
.detail-photo{background:var(--card2);margin:16px;border-radius:16px;padding:20px;display:flex;justify-content:center;align-items:center;min-height:180px}
.detail-photo img{max-width:100%;max-height:220px;border-radius:12px;object-fit:contain}
.detail-photo .no-photo{font-size:80px;opacity:0.3}
.detail-photos-dual{display:flex;gap:12px;justify-content:center}
.detail-photos-dual img{max-width:45%;max-height:180px;border-radius:12px;object-fit:contain}
.detail-tabs{display:flex;margin:0 16px;background:var(--card);border-radius:12px;padding:4px}
.detail-tab{flex:1;padding:12px;text-align:center;border-radius:10px;cursor:pointer;font-size:14px;color:var(--muted);transition:all 0.2s}
.detail-tab.active{background:var(--accent2);color:var(--bg);font-weight:600}
.detail-content{padding:16px}
.detail-title{font-size:22px;font-weight:700;margin-bottom:4px;display:flex;align-items:center;gap:8px}
.detail-title .flag{font-size:20px}
.detail-year{color:var(--muted);font-size:16px;margin-bottom:20px}
.detail-section{margin-bottom:24px}
.detail-section h3{font-size:14px;font-weight:600;margin-bottom:12px;color:var(--accent2)}
.detail-row{background:var(--card);border-radius:12px;padding:14px 16px;display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.detail-row .label{color:var(--muted);font-size:14px}
.detail-row .value{font-size:16px;font-weight:600}
.detail-row .value.up{color:var(--success)}
.detail-row .value.down{color:var(--danger)}
.detail-row .value.premium{color:var(--accent2)}
.detail-row .value.silver{color:var(--silver)}
.detail-price-box{background:var(--card);border-radius:12px;padding:16px;display:grid;grid-template-columns:1fr 1fr;gap:16px}
.detail-price-item{text-align:center}
.detail-price-item .label{font-size:11px;color:var(--muted);margin-bottom:4px}
.detail-price-item .value{font-size:18px;font-weight:700}
.detail-price-item .value.silver{color:var(--silver)}
.detail-price-item .value.gold{color:var(--accent2)}
.detail-price-item .sub{font-size:11px;color:var(--muted)}
.detail-notes{background:var(--card);border-radius:12px;padding:16px;color:var(--muted);font-size:14px;line-height:1.5}
.detail-actions{display:flex;gap:12px;padding:16px}
.detail-actions button{flex:1;padding:16px;border-radius:12px;font-size:16px;cursor:pointer;border:none}
.btn-edit{background:var(--card2);color:var(--text)}
.btn-delete{background:rgba(239,68,68,0.15);color:var(--danger)}
.import-zone{border:2px dashed var(--border);border-radius:12px;padding:30px;text-align:center;color:var(--muted);cursor:pointer;margin-bottom:16px}
.import-zone:hover{border-color:var(--accent);color:var(--text)}
#csvInput{display:none}

/* SETTINGS */
.settings-item{background:var(--card2);border-radius:12px;padding:16px;margin-bottom:12px;display:flex;justify-content:space-between;align-items:center}
.settings-item .info h4{font-size:15px;margin-bottom:4px}
.settings-item .info p{font-size:12px;color:var(--muted)}
.settings-item button{padding:10px 16px;border-radius:8px;border:none;cursor:pointer;font-size:13px}
.settings-item .btn-on{background:var(--success);color:#fff}
.settings-item .btn-off{background:var(--card);color:var(--text);border:1px solid var(--border)}
</style>
</head>
<body>

<!-- LOCK SCREEN -->
<div class="lock-screen" id="lockScreen">
<div class="lock-icon">ğŸ”’</div>
<div class="lock-title">Silver Vault</div>
<div class="lock-subtitle" id="lockSubtitle">Entrez votre code PIN</div>
<div class="pin-dots">
<div class="pin-dot" id="dot0"></div>
<div class="pin-dot" id="dot1"></div>
<div class="pin-dot" id="dot2"></div>
<div class="pin-dot" id="dot3"></div>
</div>
<div class="pin-pad">
<button class="pin-btn" onclick="pinInput('1')">1</button>
<button class="pin-btn" onclick="pinInput('2')">2</button>
<button class="pin-btn" onclick="pinInput('3')">3</button>
<button class="pin-btn" onclick="pinInput('4')">4</button>
<button class="pin-btn" onclick="pinInput('5')">5</button>
<button class="pin-btn" onclick="pinInput('6')">6</button>
<button class="pin-btn" onclick="pinInput('7')">7</button>
<button class="pin-btn" onclick="pinInput('8')">8</button>
<button class="pin-btn" onclick="pinInput('9')">9</button>
<button class="pin-btn empty"></button>
<button class="pin-btn" onclick="pinInput('0')">0</button>
<button class="pin-btn del" onclick="pinDelete()">âŒ«</button>
</div>
<div class="lock-error" id="lockError"></div>
</div>

<header>
<div class="header-top">
<div class="logo"><div class="logo-icon">ğŸª™</div><h1>Silver Vault</h1></div>
<div class="header-actions">
<button class="btn-lock" onclick="openSettings()" title="ParamÃ¨tres">âš™ï¸</button>
<div class="price-box" onclick="togglePriceEdit()">
<strong id="priceDisplay">3.12â‚¬</strong><span>/g</span>
<button class="btn-refresh" id="btnRefresh" onclick="event.stopPropagation();fetchPrice()">ğŸ”„</button>
</div>
</div>
</div>
<div class="stats-bar">
<div class="stat-mini"><div class="value silver" id="statMetal">0,00 â‚¬</div><div class="label">Valeur mÃ©tal</div></div>
<div class="stat-mini"><div class="value gold" id="statNumis">0,00 â‚¬</div><div class="label">Valeur numismatique</div></div>
</div>
<div class="stats-bar-2">
<div class="stat-mini"><div class="value" id="statTotal">0,00 â‚¬</div><div class="label">Total</div></div>
<div class="stat-mini"><div class="value" id="statPure">0 g</div><div class="label">Argent pur</div></div>
<div class="stat-mini"><div class="value" id="statCount">0</div><div class="label">PiÃ¨ces</div></div>
</div>
<div class="price-info" id="priceInfo">Appuyez sur le prix pour modifier</div>
<div class="price-edit" id="priceEdit">
<label>Prix argent (â‚¬/g) :</label>
<div class="price-edit-row">
<input type="number" id="manualInput" step="0.01" placeholder="3.12" inputmode="decimal">
<button onclick="setManualPrice()">OK</button>
</div>
</div>
</header>
<main>
<div class="actions">
<div class="search-box"><input type="text" id="searchInput" placeholder="Rechercher..." oninput="render()"></div>
<button class="btn-add" onclick="openForm(null)">+</button>
<button class="btn-icon" onclick="openImport()">ğŸ“¥</button>
<button class="btn-icon" onclick="exportCSV()">ğŸ“¤</button>
</div>
<div class="sort-row">
<button class="sort-btn active" onclick="setSort('date')">ğŸ“… RÃ©cent</button>
<button class="sort-btn" onclick="setSort('value')">ğŸ’° Valeur</button>
<button class="sort-btn" onclick="setSort('weight')">âš–ï¸ Poids</button>
<button class="sort-btn" onclick="setSort('country')">ğŸŒ Pays</button>
<button class="sort-btn" onclick="setSort('name')">ğŸ”¤ Nom</button>
</div>
<div class="chart-section">
<div class="chart-header">
<h3>ğŸ“ˆ Ã‰volution</h3>
<div class="chart-legend">
<span><div class="dot metal"></div>MÃ©tal</span>
<span><div class="dot numis"></div>Numis.</span>
</div>
</div>
<div id="chartContainer"></div>
</div>
<div id="list" class="coins-list"></div>
</main>

<div class="detail-view" id="detailView">
<div class="detail-header">
<button class="btn-back" onclick="closeDetail()">â†</button>
<h2 id="detailName">PiÃ¨ce</h2>
<button class="btn-settings" onclick="editCurrent()">âš™ï¸</button>
</div>
<div class="detail-photo" id="detailPhoto"></div>
<div class="detail-tabs">
<div class="detail-tab active" id="tabData" onclick="switchTab('data')">Vos donnÃ©es</div>
<div class="detail-tab" id="tabInfo" onclick="switchTab('info')">Informations</div>
</div>
<div class="detail-content" id="detailContent"></div>
<div class="detail-actions">
<button class="btn-edit" onclick="editCurrent()">âœï¸ Modifier</button>
<button class="btn-delete" onclick="deleteCurrent()">ğŸ—‘ï¸ Supprimer</button>
</div>
</div>

<!-- SETTINGS MODAL -->
<div class="modal" id="settingsModal">
<div class="modal-content">
<div class="modal-header"><h2>âš™ï¸ ParamÃ¨tres</h2><button class="btn-close" onclick="closeSettings()">âœ•</button></div>
<div class="modal-body">
<div class="settings-item">
<div class="info">
<h4>ğŸ”’ Code PIN</h4>
<p id="pinStatus">Non configurÃ©</p>
</div>
<button id="pinToggleBtn" class="btn-off" onclick="togglePin()">Activer</button>
</div>
<div class="settings-item" id="changePinItem" style="display:none">
<div class="info">
<h4>ğŸ”‘ Changer le PIN</h4>
<p>Modifier votre code</p>
</div>
<button class="btn-off" onclick="changePin()">Changer</button>
</div>
</div>
</div>
</div>

<!-- PIN SETUP MODAL -->
<div class="modal" id="pinSetupModal">
<div class="modal-content" style="max-width:350px">
<div class="modal-header"><h2 id="pinSetupTitle">CrÃ©er un PIN</h2><button class="btn-close" onclick="closePinSetup()">âœ•</button></div>
<div class="modal-body" style="text-align:center;padding:30px">
<p id="pinSetupText" style="color:var(--muted);margin-bottom:20px">Entrez un code Ã  4 chiffres</p>
<div class="pin-dots" style="justify-content:center">
<div class="pin-dot" id="sdot0"></div>
<div class="pin-dot" id="sdot1"></div>
<div class="pin-dot" id="sdot2"></div>
<div class="pin-dot" id="sdot3"></div>
</div>
<div class="pin-pad" style="margin:20px auto">
<button class="pin-btn" onclick="setupPinInput('1')">1</button>
<button class="pin-btn" onclick="setupPinInput('2')">2</button>
<button class="pin-btn" onclick="setupPinInput('3')">3</button>
<button class="pin-btn" onclick="setupPinInput('4')">4</button>
<button class="pin-btn" onclick="setupPinInput('5')">5</button>
<button class="pin-btn" onclick="setupPinInput('6')">6</button>
<button class="pin-btn" onclick="setupPinInput('7')">7</button>
<button class="pin-btn" onclick="setupPinInput('8')">8</button>
<button class="pin-btn" onclick="setupPinInput('9')">9</button>
<button class="pin-btn empty"></button>
<button class="pin-btn" onclick="setupPinInput('0')">0</button>
<button class="pin-btn del" onclick="setupPinDelete()">âŒ«</button>
</div>
</div>
</div>
</div>

<div class="modal" id="formModal">
<div class="modal-content">
<div class="modal-header"><h2 id="formTitle">Ajouter</h2><button class="btn-close" onclick="closeForm()">âœ•</button></div>
<div class="modal-body">
<input type="hidden" id="fId">
<input type="file" id="photoInput" accept="image/*" onchange="handlePhoto(event,1)">
<input type="file" id="photoInput2" accept="image/*" onchange="handlePhoto(event,2)">
<div class="form-row">
<div class="photo-section">
<label>Avant</label>
<div class="photo-preview" onclick="document.getElementById('photoInput').click()">
<div class="placeholder" id="ph1"><span>ğŸ“·</span></div>
<img id="img1" style="display:none">
</div>
</div>
<div class="photo-section">
<label>ArriÃ¨re</label>
<div class="photo-preview" onclick="document.getElementById('photoInput2').click()">
<div class="placeholder" id="ph2"><span>ğŸ“·</span></div>
<img id="img2" style="display:none">
</div>
</div>
</div>
<div class="form-group"><label>Nom *</label><input type="text" id="fName" placeholder="American Silver Eagle"></div>
<div class="form-row-3">
<div class="form-group"><label>Pays</label><input type="text" id="fCountry" placeholder="USA"></div>
<div class="form-group"><label>AnnÃ©e</label><input type="number" id="fYear" inputmode="numeric"></div>
<div class="form-group"><label>QuantitÃ©</label><input type="number" id="fQty" value="1" min="1" inputmode="numeric" oninput="calcPreview()"></div>
</div>
<div class="form-row">
<div class="form-group"><label>Poids unitaire (g) *</label><input type="number" id="fWeight" step="0.001" placeholder="31.103" oninput="calcPreview()" inputmode="decimal"></div>
<div class="form-group"><label>Titre</label>
<select id="fPurity" onchange="onPurityChange()">
<option value="999">.999</option><option value="980">.980</option><option value="970">.970</option>
<option value="960">.960</option><option value="958">.958</option><option value="950">.950</option>
<option value="935">.935</option><option value="930">.930</option><option value="925">.925</option>
<option value="916">.916</option><option value="915">.915</option><option value="900">.900</option>
<option value="875">.875</option><option value="844">.844</option><option value="840">.840</option>
<option value="835">.835</option><option value="833">.833</option><option value="830">.830</option>
<option value="813">.813</option><option value="800">.800</option><option value="750">.750</option>
<option value="720">.720</option><option value="700">.700</option><option value="687">.687</option>
<option value="625">.625</option><option value="600">.600</option><option value="500">.500</option>
<option value="400">.400</option><option value="custom">Autre...</option>
</select>
</div>
</div>
<div class="form-group" id="customPurityGroup" style="display:none"><label>PuretÃ© (1-999)</label><input type="number" id="fCustomPurity" min="1" max="999" oninput="calcPreview()" inputmode="numeric"></div>
<div class="form-row">
<div class="form-group"><label>Prix achat total (â‚¬)</label><input type="number" id="fPrice" step="0.01" inputmode="decimal" oninput="calcPreview()"></div>
<div class="form-group"><label>Valeur numismatique (â‚¬)</label><input type="number" id="fPremium" step="0.01" inputmode="decimal" placeholder="Optionnel" oninput="calcPreview()"></div>
</div>
<div class="calc-preview">
<div class="calc-preview-row"><span>Argent pur (total)</span><strong id="prevPure">0 g</strong></div>
<div class="calc-preview-row"><span>Valeur mÃ©tal</span><strong class="silver" id="prevMetal">0 â‚¬</strong></div>
<div class="calc-preview-row"><span>Valeur numismatique</span><strong class="gold" id="prevPremium">â€”</strong></div>
<div class="calc-preview-row"><span>Valeur estimÃ©e</span><strong class="total" id="prevValue">0 â‚¬</strong></div>
</div>
<div class="form-row">
<div class="form-group"><label>Date achat</label><input type="date" id="fDate"></div>
</div>
<div class="form-group"><label>Notes</label><textarea id="fNotes" rows="2"></textarea></div>
</div>
<div class="modal-footer"><button class="btn-cancel" onclick="closeForm()">Annuler</button><button class="btn-save" onclick="save()">Enregistrer</button></div>
</div>
</div>

<div class="modal" id="importModal">
<div class="modal-content">
<div class="modal-header"><h2>Importer CSV</h2><button class="btn-close" onclick="closeImport()">âœ•</button></div>
<div class="modal-body">
<input type="file" id="csvInput" accept=".csv" onchange="handleCSV(event)">
<div class="import-zone" onclick="document.getElementById('csvInput').click()">
<div style="font-size:40px;margin-bottom:10px">ğŸ“„</div>
<div>Appuyez pour sÃ©lectionner un fichier CSV</div>
</div>
<div id="importPreview"></div>
</div>
<div class="modal-footer">
<button class="btn-cancel" onclick="closeImport()">Annuler</button>
<button class="btn-save" id="btnImport" onclick="confirmImport()" style="display:none">Importer</button>
</div>
</div>
</div>

<div class="modal" id="delModal">
<div class="modal-content" style="max-width:350px;text-align:center">
<div class="modal-body" style="padding:30px">
<div style="font-size:48px;margin-bottom:16px">ğŸ—‘ï¸</div>
<h3>Supprimer ?</h3>
<p style="color:var(--muted);margin:16px 0">IrrÃ©versible</p>
<input type="hidden" id="delId">
<div style="display:flex;gap:12px"><button class="btn-cancel" onclick="closeDel()">Annuler</button><button class="btn-delete" style="flex:1;padding:14px" onclick="confirmDel()">Supprimer</button></div>
</div>
</div>
</div>

<script>
var coins=[],price=3.12,OZ=31.1035,KEY="silver_vault_coins",HKEY="silver_vault_history",PKEY="silver_vault_pin";
var photo1=null,photo2=null,viewId=null,viewTab="data",sortBy="date",importData=[];
var enteredPin="",setupPin="",setupStep=0,isChangingPin=false;

var FLAGS={"france":"ğŸ‡«ğŸ‡·","suisse":"ğŸ‡¨ğŸ‡­","switzerland":"ğŸ‡¨ğŸ‡­","usa":"ğŸ‡ºğŸ‡¸","etats-unis":"ğŸ‡ºğŸ‡¸","Ã©tats-unis":"ğŸ‡ºğŸ‡¸","united states":"ğŸ‡ºğŸ‡¸","allemagne":"ğŸ‡©ğŸ‡ª","germany":"ğŸ‡©ğŸ‡ª","belgique":"ğŸ‡§ğŸ‡ª","belgium":"ğŸ‡§ğŸ‡ª","italie":"ğŸ‡®ğŸ‡¹","italy":"ğŸ‡®ğŸ‡¹","espagne":"ğŸ‡ªğŸ‡¸","spain":"ğŸ‡ªğŸ‡¸","royaume-uni":"ğŸ‡¬ğŸ‡§","uk":"ğŸ‡¬ğŸ‡§","united kingdom":"ğŸ‡¬ğŸ‡§","angleterre":"ğŸ‡¬ğŸ‡§","canada":"ğŸ‡¨ğŸ‡¦","australie":"ğŸ‡¦ğŸ‡º","australia":"ğŸ‡¦ğŸ‡º","autriche":"ğŸ‡¦ğŸ‡¹","austria":"ğŸ‡¦ğŸ‡¹","pays-bas":"ğŸ‡³ğŸ‡±","netherlands":"ğŸ‡³ğŸ‡±","portugal":"ğŸ‡µğŸ‡¹","grece":"ğŸ‡¬ğŸ‡·","greece":"ğŸ‡¬ğŸ‡·","mexique":"ğŸ‡²ğŸ‡½","mexico":"ğŸ‡²ğŸ‡½","chine":"ğŸ‡¨ğŸ‡³","china":"ğŸ‡¨ğŸ‡³","japon":"ğŸ‡¯ğŸ‡µ","japan":"ğŸ‡¯ğŸ‡µ","russie":"ğŸ‡·ğŸ‡º","russia":"ğŸ‡·ğŸ‡º","afrique":"ğŸŒ","chad":"ğŸ‡¹ğŸ‡©","tchad":"ğŸ‡¹ğŸ‡©","congo":"ğŸ‡¨ğŸ‡¬","cameroun":"ğŸ‡¨ğŸ‡²","gabon":"ğŸ‡¬ğŸ‡¦","pologne":"ğŸ‡µğŸ‡±","poland":"ğŸ‡µğŸ‡±"};

function getFlag(country){if(!country)return"";return FLAGS[country.toLowerCase().trim()]||""}

// PIN SYSTEM
function hashPin(pin){var h=0;for(var i=0;i<pin.length;i++){h=((h<<5)-h)+pin.charCodeAt(i);h=h&h}return h.toString()}
function hasPin(){return localStorage.getItem(PKEY)!==null}
function checkPin(pin){return hashPin(pin)===localStorage.getItem(PKEY)}
function savePin(pin){localStorage.setItem(PKEY,hashPin(pin))}
function removePin(){localStorage.removeItem(PKEY)}

function updatePinDots(prefix,len){
  for(var i=0;i<4;i++){
    var dot=document.getElementById(prefix+i);
    dot.classList.toggle("filled",i<len);
    dot.classList.remove("error");
  }
}

function showPinError(){
  for(var i=0;i<4;i++)document.getElementById("dot"+i).classList.add("error");
  document.getElementById("lockError").textContent="Code incorrect";
  setTimeout(function(){
    enteredPin="";
    updatePinDots("dot",0);
    document.getElementById("lockError").textContent="";
  },500);
}

function pinInput(n){
  if(enteredPin.length>=4)return;
  enteredPin+=n;
  updatePinDots("dot",enteredPin.length);
  if(enteredPin.length===4){
    setTimeout(function(){
      if(checkPin(enteredPin)){
        document.getElementById("lockScreen").classList.add("hidden");
      }else{
        showPinError();
      }
    },200);
  }
}

function pinDelete(){
  if(enteredPin.length>0){
    enteredPin=enteredPin.slice(0,-1);
    updatePinDots("dot",enteredPin.length);
  }
}

function initLock(){
  if(hasPin()){
    document.getElementById("lockScreen").classList.remove("hidden");
  }else{
    document.getElementById("lockScreen").classList.add("hidden");
  }
}

// SETTINGS
function openSettings(){
  document.getElementById("settingsModal").classList.add("active");
  updateSettingsUI();
}
function closeSettings(){document.getElementById("settingsModal").classList.remove("active")}

function updateSettingsUI(){
  var has=hasPin();
  document.getElementById("pinStatus").textContent=has?"ActivÃ© âœ“":"Non configurÃ©";
  document.getElementById("pinToggleBtn").textContent=has?"DÃ©sactiver":"Activer";
  document.getElementById("pinToggleBtn").className=has?"btn-on":"btn-off";
  document.getElementById("changePinItem").style.display=has?"flex":"none";
}

function togglePin(){
  if(hasPin()){
    removePin();
    updateSettingsUI();
  }else{
    isChangingPin=false;
    openPinSetup();
  }
}

function changePin(){
  isChangingPin=true;
  openPinSetup();
}

function openPinSetup(){
  setupPin="";setupStep=0;
  document.getElementById("pinSetupTitle").textContent=isChangingPin?"Changer le PIN":"CrÃ©er un PIN";
  document.getElementById("pinSetupText").textContent="Entrez un code Ã  4 chiffres";
  updatePinDots("sdot",0);
  document.getElementById("pinSetupModal").classList.add("active");
}

function closePinSetup(){document.getElementById("pinSetupModal").classList.remove("active")}

function setupPinInput(n){
  if(setupPin.length>=4)return;
  setupPin+=n;
  updatePinDots("sdot",setupPin.length);
  if(setupPin.length===4){
    setTimeout(function(){
      if(setupStep===0){
        setupStep=1;
        var firstPin=setupPin;
        setupPin="";
        updatePinDots("sdot",0);
        document.getElementById("pinSetupText").textContent="Confirmez le code";
        setupPin="";
        window.tempPin=firstPin;
      }else{
        if(setupPin===window.tempPin){
          savePin(setupPin);
          closePinSetup();
          updateSettingsUI();
        }else{
          document.getElementById("pinSetupText").textContent="Les codes ne correspondent pas. RÃ©essayez.";
          setupPin="";setupStep=0;
          updatePinDots("sdot",0);
        }
      }
    },200);
  }
}

function setupPinDelete(){
  if(setupPin.length>0){
    setupPin=setupPin.slice(0,-1);
    updatePinDots("sdot",setupPin.length);
  }
}

// DATA
function load(){
  var k=["silver_vault_coins","sv2_coins","sv_coins"];
  for(var i=0;i<k.length;i++){try{var d=localStorage.getItem(k[i]);if(d){var p=JSON.parse(d);if(Array.isArray(p)&&p.length>0){coins=p;break}}}catch(e){}}
  var pk=["silver_vault_price","sv2_price"];
  for(var i=0;i<pk.length;i++){try{var v=parseFloat(localStorage.getItem(pk[i]));if(v>0){price=v;break}}catch(e){}}
}
function saveCoins(){try{localStorage.setItem(KEY,JSON.stringify(coins));saveHistory()}catch(e){}}
function savePrice(){try{localStorage.setItem("silver_vault_price",price.toString())}catch(e){}}

function calcTotals(){
  var metalTotal=0,numisTotal=0,pureTotal=0,count=0;
  for(var i=0;i<coins.length;i++){
    var c=coins[i],qty=c.qty||1;
    var p=pure(c.weight||0,c.purity||999)*qty;
    metalTotal+=val(p);
    numisTotal+=c.premium?c.premium*qty:0;
    pureTotal+=p;
    count+=qty;
  }
  return{metal:metalTotal,numis:numisTotal,pure:pureTotal,count:count};
}

function saveHistory(){
  try{
    var h=JSON.parse(localStorage.getItem(HKEY)||"[]");
    var today=new Date().toISOString().split("T")[0];
    var t=calcTotals();
    var entry={date:today,metal:Math.round(t.metal*100)/100,numis:Math.round(t.numis*100)/100};
    if(h.length===0||h[h.length-1].date!==today){h.push(entry);if(h.length>30)h=h.slice(-30)}
    else h[h.length-1]=entry;
    localStorage.setItem(HKEY,JSON.stringify(h));
  }catch(e){}
}

function getHistory(){try{return JSON.parse(localStorage.getItem(HKEY)||"[]")}catch(e){return[]}}

function togglePriceEdit(){var e=document.getElementById("priceEdit");e.classList.toggle("show");if(e.classList.contains("show"))document.getElementById("manualInput").value=price.toFixed(2)}
function setManualPrice(){var v=parseFloat(document.getElementById("manualInput").value);if(v>0){price=v;updatePriceUI();savePrice();updateStats();render();document.getElementById("priceEdit").classList.remove("show")}}
function updatePriceUI(){document.getElementById("priceDisplay").textContent=price.toFixed(2)+"â‚¬";document.getElementById("priceInfo").textContent=price.toFixed(2)+" â‚¬/g (~"+(price*OZ/0.92).toFixed(0)+" $/oz)"}
function fetchPrice(){var b=document.getElementById("btnRefresh");b.classList.add("spin");fetch("https://api.metals.live/v1/spot/silver").then(function(r){return r.json()}).then(function(d){var u=Array.isArray(d)?d[0].price:d.price;if(u>0){price=(u*0.92)/OZ;updatePriceUI();savePrice();updateStats();render()}}).catch(function(){}).finally(function(){b.classList.remove("spin")})}

function pure(w,p){return(w*p)/1000}
function val(p){return p*price}
function fmt(v){return v.toLocaleString("fr-FR",{style:"currency",currency:"EUR"})}
function fmtW(v){return v.toFixed(3)+" g"}

function updateStats(){
  var t=calcTotals();
  document.getElementById("statMetal").textContent=fmt(t.metal);
  document.getElementById("statNumis").textContent=t.numis>0?fmt(t.numis):"â€”";
  document.getElementById("statTotal").textContent=fmt(t.numis>0?t.numis:t.metal);
  document.getElementById("statPure").textContent=fmtW(t.pure);
  document.getElementById("statCount").textContent=t.count;
}

function getCoin(id){for(var i=0;i<coins.length;i++)if(coins[i].id===id)return coins[i];return null}

function setSort(s){sortBy=s;document.querySelectorAll(".sort-btn").forEach(function(b){b.classList.remove("active")});event.target.classList.add("active");render()}

function sortCoins(arr){
  var sorted=arr.slice();
  sorted.sort(function(a,b){
    if(sortBy==="value"){
      var va=(a.premium?a.premium:val(pure(a.weight||0,a.purity||999)))*(a.qty||1);
      var vb=(b.premium?b.premium:val(pure(b.weight||0,b.purity||999)))*(b.qty||1);
      return vb-va;
    }
    if(sortBy==="weight")return(pure(b.weight||0,b.purity||999)*(b.qty||1))-(pure(a.weight||0,a.purity||999)*(a.qty||1));
    if(sortBy==="country")return(a.country||"").localeCompare(b.country||"");
    if(sortBy==="name")return(a.name||"").localeCompare(b.name||"");
    return(b.id||"").localeCompare(a.id||"");
  });
  return sorted;
}

function renderChart(){
  var h=getHistory();
  var container=document.getElementById("chartContainer");
  if(h.length<2){container.innerHTML="<div class='chart-empty'>Ajoutez des piÃ¨ces pour voir l'Ã©volution</div>";return}
  var maxM=Math.max.apply(null,h.map(function(x){return x.metal||0}));
  var maxN=Math.max.apply(null,h.map(function(x){return x.numis||0}));
  var max=Math.max(maxM,maxN,1);
  var bars="";
  for(var i=0;i<h.length;i++){
    var pctM=max>0?((h[i].metal||0)/max)*100:0;
    var pctN=max>0?((h[i].numis||0)/max)*100:0;
    bars+="<div class='chart-bar-group'>";
    if(h[i].numis>0)bars+="<div class='chart-bar numis' style='height:"+pctN+"%'></div>";
    bars+="<div class='chart-bar metal' style='height:"+pctM+"%'></div></div>";
  }
  container.innerHTML="<div class='chart-container'>"+bars+"</div><div class='chart-labels'><span>"+h[0].date.slice(5)+"</span><span>"+h[h.length-1].date.slice(5)+"</span></div>";
}

function render(){
  renderChart();
  var q=document.getElementById("searchInput").value.toLowerCase(),list=document.getElementById("list"),f=[];
  for(var i=0;i<coins.length;i++){var c=coins[i];if(!q||(c.name&&c.name.toLowerCase().indexOf(q)>=0)||(c.country&&c.country.toLowerCase().indexOf(q)>=0))f.push(c)}
  f=sortCoins(f);
  if(!f.length){list.innerHTML="<div class='empty-state'><div class='icon'>ğŸª™</div><h3>"+(coins.length?"Aucun rÃ©sultat":"Collection vide")+"</h3><p>"+(coins.length?"":"Appuyez sur + pour ajouter")+"</p></div>";return}
  var html="";
  for(var i=0;i<f.length;i++){
    var c=f[i],qty=c.qty||1,p=pure(c.weight||0,c.purity||999)*qty,metalV=val(p);
    var numisV=c.premium?c.premium*qty:0;
    var displayVal=numisV>0?numisV:metalV;
    var g=c.purchasePrice?displayVal-c.purchasePrice:null;
    var gp=c.purchasePrice?((g/c.purchasePrice)*100).toFixed(1):null;
    var ic=c.photo?"<img src='"+c.photo+"'>":"ğŸ›ï¸";
    var flag=getFlag(c.country);
    var qtyBadge=qty>1?"<span class='coin-qty'>x"+qty+"</span>":"";
    html+="<div class='coin-card' onclick=\"openDetail('"+c.id+"')\"><div class='coin-header'><div class='coin-icon'>"+ic+qtyBadge+"</div><div class='coin-info'><h3>"+(flag?"<span class='flag'>"+flag+"</span>":"")+(c.name||"?")+"</h3><div class='coin-meta'>"+(c.country?"<span>"+c.country+"</span>":"")+(c.year?"<span>"+c.year+"</span>":"")+"<span class='purity-badge'>."+(c.purity||999)+"</span></div></div><div class='coin-value'><div class='main'>"+fmt(displayVal)+"</div><div class='metal'>MÃ©tal: "+fmt(metalV)+"</div>"+(numisV>0?"<div class='premium'>Numis: "+fmt(numisV)+"</div>":"")+(gp!==null?"<div class='change "+(g>=0?"up":"down")+"'>"+(g>=0?"â–²":"â–¼")+" "+gp+"%</div>":"")+"</div></div><div class='coin-details'><div><span>Poids</span><br><strong>"+fmtW((c.weight||0)*qty)+"</strong></div><div><span>Pur</span><br><strong>"+fmtW(p)+"</strong></div><div><span>Achat</span><br><strong>"+(c.purchasePrice?fmt(c.purchasePrice):"-")+"</strong></div></div></div>"
  }
  list.innerHTML=html
}

function openDetail(id){
  viewId=id;viewTab="data";
  var c=getCoin(id);if(!c)return;
  var flag=getFlag(c.country);
  document.getElementById("detailName").textContent=(flag?flag+" ":"")+(c.name||"Sans nom");
  var ph=document.getElementById("detailPhoto");
  if(c.photo&&c.photo2)ph.innerHTML="<div class='detail-photos-dual'><img src='"+c.photo+"'><img src='"+c.photo2+"'></div>";
  else if(c.photo)ph.innerHTML="<img src='"+c.photo+"'>";
  else ph.innerHTML="<div class='no-photo'>ğŸª™</div>";
  updateTabs();renderDetail();
  document.getElementById("detailView").classList.add("active");
}
function closeDetail(){document.getElementById("detailView").classList.remove("active");viewId=null}
function switchTab(t){viewTab=t;updateTabs();renderDetail()}
function updateTabs(){document.getElementById("tabData").classList.toggle("active",viewTab==="data");document.getElementById("tabInfo").classList.toggle("active",viewTab==="info")}

function renderDetail(){
  var c=getCoin(viewId);if(!c)return;
  var qty=c.qty||1,p=pure(c.weight||0,c.purity||999)*qty,metalV=val(p);
  var numisV=c.premium?c.premium*qty:0;
  var displayVal=numisV>0?numisV:metalV;
  var g=c.purchasePrice?displayVal-c.purchasePrice:null,gp=c.purchasePrice?((g/c.purchasePrice)*100).toFixed(1):null;
  var flag=getFlag(c.country);
  var h="<div class='detail-title'>"+(flag?"<span class='flag'>"+flag+"</span>":"")+c.name+(qty>1?" <span style='color:var(--muted)'>(x"+qty+")</span>":"")+"</div><div class='detail-year'>"+(c.year||"")+"</div>";
  if(viewTab==="data"){
    h+="<div class='detail-section'><h3>ğŸ’° Valeurs</h3><div class='detail-price-box'><div class='detail-price-item'><div class='label'>Valeur mÃ©tal</div><div class='value silver'>"+fmt(metalV)+"</div></div><div class='detail-price-item'><div class='label'>Valeur numismatique</div><div class='value gold'>"+(numisV>0?fmt(numisV):"â€”")+"</div></div></div></div>";
    if(numisV>0)h+="<div class='detail-section'><h3>â­ Prime</h3><div class='detail-row'><span class='label'>Prime vs mÃ©tal</span><span class='value premium'>+"+(((numisV/metalV)-1)*100).toFixed(0)+"%</span></div></div>";
    h+="<div class='detail-section'><h3>ğŸ“Š Performance</h3><div class='detail-row'><span class='label'>Prix d'achat</span><span class='value'>"+(c.purchasePrice?fmt(c.purchasePrice):"â€”")+"</span></div><div class='detail-row'><span class='label'>Gain/Perte</span><span class='value "+(g>=0?"up":"down")+"'>"+(gp!==null?(g>=0?"+":"")+gp+"%":"â€”")+"</span></div><div class='detail-row'><span class='label'>Date</span><span class='value'>"+(c.purchaseDate||"â€”")+"</span></div></div>";
    if(c.notes)h+="<div class='detail-section'><h3>ğŸ“ Notes</h3><div class='detail-notes'>"+c.notes+"</div></div>";
  }else{
    h+="<div class='detail-section'><h3>ğŸ“‹ CaractÃ©ristiques</h3><div class='detail-row'><span class='label'>Pays</span><span class='value'>"+(flag?flag+" ":"")+(c.country||"â€”")+"</span></div><div class='detail-row'><span class='label'>AnnÃ©e</span><span class='value'>"+(c.year||"â€”")+"</span></div><div class='detail-row'><span class='label'>QuantitÃ©</span><span class='value'>"+qty+"</span></div><div class='detail-row'><span class='label'>Poids unitaire</span><span class='value'>"+fmtW(c.weight||0)+"</span></div><div class='detail-row'><span class='label'>Poids total</span><span class='value'>"+fmtW((c.weight||0)*qty)+"</span></div><div class='detail-row'><span class='label'>Titre</span><span class='value'>."+(c.purity||999)+"</span></div><div class='detail-row'><span class='label'>Argent pur</span><span class='value'>"+fmtW(p)+"</span></div></div>";
  }
  document.getElementById("detailContent").innerHTML=h;
}

function editCurrent(){var id=viewId;closeDetail();openForm(id)}
function deleteCurrent(){document.getElementById("delId").value=viewId;document.getElementById("delModal").classList.add("active")}

function handlePhoto(e,n){
  var f=e.target.files[0];if(!f)return;
  var r=new FileReader();
  r.onload=function(ev){
    var img=new Image();
    img.onload=function(){
      var cv=document.createElement("canvas"),max=400,w=img.width,h=img.height;
      if(w>h){if(w>max){h=h*(max/w);w=max}}else{if(h>max){w=w*(max/h);h=max}}
      cv.width=w;cv.height=h;cv.getContext("2d").drawImage(img,0,0,w,h);
      var d=cv.toDataURL("image/jpeg",0.7);
      if(n===1){photo1=d;document.getElementById("ph1").style.display="none";document.getElementById("img1").src=d;document.getElementById("img1").style.display="block"}
      else{photo2=d;document.getElementById("ph2").style.display="none";document.getElementById("img2").src=d;document.getElementById("img2").style.display="block"}
    };img.src=ev.target.result;
  };r.readAsDataURL(f);
}
function resetForm(){
  photo1=null;photo2=null;
  document.getElementById("ph1").style.display="block";document.getElementById("ph2").style.display="block";
  document.getElementById("img1").style.display="none";document.getElementById("img2").style.display="none";
  document.getElementById("photoInput").value="";document.getElementById("photoInput2").value="";
}
function onPurityChange(){document.getElementById("customPurityGroup").style.display=document.getElementById("fPurity").value==="custom"?"block":"none";calcPreview()}
function getPurity(){var s=document.getElementById("fPurity");return s.value==="custom"?(parseInt(document.getElementById("fCustomPurity").value)||999):(parseInt(s.value)||999)}

function calcPreview(){
  var w=parseFloat(document.getElementById("fWeight").value)||0;
  var qty=parseInt(document.getElementById("fQty").value)||1;
  var pu=pure(w,getPurity())*qty;
  var metal=val(pu);
  var prem=parseFloat(document.getElementById("fPremium").value)||0;
  document.getElementById("prevPure").textContent=fmtW(pu);
  document.getElementById("prevMetal").textContent=fmt(metal);
  document.getElementById("prevPremium").textContent=prem>0?fmt(prem):"â€”";
  document.getElementById("prevValue").textContent=fmt(prem>0?prem:metal);
}

function openForm(id){
  document.getElementById("formModal").classList.add("active");
  document.getElementById("formTitle").textContent=id?"Modifier":"Ajouter";
  document.getElementById("customPurityGroup").style.display="none";
  resetForm();
  var c=id?getCoin(id):null;
  document.getElementById("fId").value=c?c.id:"";
  document.getElementById("fName").value=c?c.name||"":"";
  document.getElementById("fCountry").value=c?c.country||"":"";
  document.getElementById("fYear").value=c?c.year||new Date().getFullYear():new Date().getFullYear();
  document.getElementById("fQty").value=c?c.qty||1:1;
  document.getElementById("fWeight").value=c?c.weight||"":"";
  document.getElementById("fPrice").value=c?c.purchasePrice||"":"";
  document.getElementById("fPremium").value=c?c.premium||"":"";
  document.getElementById("fDate").value=c?c.purchaseDate||"":"";
  document.getElementById("fNotes").value=c?c.notes||"":"";
  if(c&&c.photo){photo1=c.photo;document.getElementById("ph1").style.display="none";document.getElementById("img1").src=c.photo;document.getElementById("img1").style.display="block"}
  if(c&&c.photo2){photo2=c.photo2;document.getElementById("ph2").style.display="none";document.getElementById("img2").src=c.photo2;document.getElementById("img2").style.display="block"}
  var pu=c?c.purity||999:999,sel=document.getElementById("fPurity"),found=false;
  for(var i=0;i<sel.options.length;i++)if(sel.options[i].value===pu.toString()){found=true;break}
  if(found)sel.value=pu.toString();else{sel.value="custom";document.getElementById("customPurityGroup").style.display="block";document.getElementById("fCustomPurity").value=pu}
  calcPreview();
}
function closeForm(){document.getElementById("formModal").classList.remove("active")}

function save(){
  var n=document.getElementById("fName").value.trim(),w=parseFloat(document.getElementById("fWeight").value);
  if(!n){alert("Nom requis");return}
  if(!w||w<=0){alert("Poids invalide");return}
  var d={name:n,country:document.getElementById("fCountry").value.trim(),year:parseInt(document.getElementById("fYear").value)||null,qty:parseInt(document.getElementById("fQty").value)||1,weight:w,purity:getPurity(),purchasePrice:parseFloat(document.getElementById("fPrice").value)||null,premium:parseFloat(document.getElementById("fPremium").value)||null,purchaseDate:document.getElementById("fDate").value||null,notes:document.getElementById("fNotes").value.trim(),photo:photo1,photo2:photo2};
  var id=document.getElementById("fId").value;
  if(id){for(var i=0;i<coins.length;i++)if(coins[i].id===id){for(var k in d)coins[i][k]=d[k];break}}
  else{d.id="c"+Date.now();coins.push(d)}
  saveCoins();updateStats();render();closeForm();
}

function openImport(){document.getElementById("importModal").classList.add("active");document.getElementById("importPreview").innerHTML="";document.getElementById("btnImport").style.display="none";importData=[]}
function closeImport(){document.getElementById("importModal").classList.remove("active");document.getElementById("csvInput").value=""}

function handleCSV(e){
  var f=e.target.files[0];if(!f)return;
  var r=new FileReader();
  r.onload=function(ev){
    var lines=ev.target.result.split("\n");
    importData=[];
    for(var i=1;i<lines.length;i++){
      var cols=lines[i].split(";");
      if(cols.length>=4&&cols[0].trim()){
        importData.push({name:cols[0].trim(),country:cols[1]?cols[1].trim():"",year:parseInt(cols[2])||null,weight:parseFloat(cols[3])||0,purity:parseInt(cols[4])||999,qty:parseInt(cols[5])||1,purchasePrice:parseFloat(cols[8])||null,premium:parseFloat(cols[9])||null});
      }
    }
    if(importData.length>0){
      document.getElementById("importPreview").innerHTML="<div style='color:var(--success)'>âœ“ "+importData.length+" piÃ¨ces</div>";
      document.getElementById("btnImport").style.display="block";
    }else{
      document.getElementById("importPreview").innerHTML="<div style='color:var(--danger)'>Aucune piÃ¨ce trouvÃ©e</div>";
    }
  };
  r.readAsText(f);
}

function confirmImport(){
  for(var i=0;i<importData.length;i++){importData[i].id="c"+Date.now()+i;coins.push(importData[i])}
  saveCoins();updateStats();render();closeImport();
}

function closeDel(){document.getElementById("delModal").classList.remove("active")}
function confirmDel(){var id=document.getElementById("delId").value,n=[];for(var i=0;i<coins.length;i++)if(coins[i].id!==id)n.push(coins[i]);coins=n;saveCoins();updateStats();render();closeDel();closeDetail()}

function exportCSV(){
  if(!coins.length){alert("Vide");return}
  var r=["Nom;Pays;Annee;Poids;Titre;Quantite;Pur;ValeurMetal;Achat;Premium"];
  for(var i=0;i<coins.length;i++){
    var c=coins[i],qty=c.qty||1,p=pure(c.weight||0,c.purity||999)*qty;
    r.push([c.name,c.country||"",c.year||"",c.weight||0,c.purity||999,qty,p.toFixed(3),val(p).toFixed(2),c.purchasePrice||"",c.premium||""].join(";"));
  }
  var a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob(["\uFEFF"+r.join("\n")],{type:"text/csv"}));
  a.download="silver_vault_"+new Date().toISOString().split("T")[0]+".csv";
  a.click();
}

load();initLock();updatePriceUI();updateStats();render();fetchPrice();
</script>
</body>
</html>
